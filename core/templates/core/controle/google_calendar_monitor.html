{% extends "core/base.html" %}

{% block title %}Monitor Google Calendar - Sistema Aprender{% endblock %}

{% block nav_controle_google_calendar %}active{% endblock %}

{% block page_title %}
<i class="bi bi-calendar-event"></i> Monitor Google Calendar
{% endblock %}

{% block breadcrumb %}
Monitore a sincronização de eventos com Google Calendar em tempo real
{% endblock %}

{% block page_actions %}
<div class="actions">
  <a href="{% url 'core:home' %}" class="btn">
    <i class="bi bi-house"></i> Dashboard
  </a>
  <button type="button" class="btn btn-primary" id="refresh-btn">
    <i class="bi bi-arrow-clockwise"></i> Atualizar
  </button>
</div>
{% endblock %}

{% block extra_css %}
<style>
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 0.75rem;
    margin-bottom: 1.5rem;
  }
  
  .stat-card {
    background: white;
    border-radius: 0.75rem;
    padding: 1rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.04);
    border: 1px solid #f8fafc;
    transition: all 0.15s ease-out;
    position: relative;
    overflow: hidden;
  }
  
  .stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 2px;
    background: var(--accent);
  }
  
  .stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.06);
    border-color: #e2e8f0;
  }
  
  .stat-card.success::before {
    background: linear-gradient(90deg, #10b981, #059669);
  }
  
  .stat-card.danger::before {
    background: linear-gradient(90deg, #ef4444, #dc2626);
  }
  
  .stat-card.warning::before {
    background: linear-gradient(90deg, #f59e0b, #d97706);
  }
  
  .stat-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 0.75rem;
  }
  
  .stat-icon {
    width: 32px;
    height: 32px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    color: white;
    background: linear-gradient(135deg, var(--accent), #2563eb);
    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
  }
  
  .stat-card.success .stat-icon {
    background: linear-gradient(135deg, #10b981, #059669);
    box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
  }
  
  .stat-card.danger .stat-icon {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
  }
  
  .stat-card.warning .stat-icon {
    background: linear-gradient(135deg, #f59e0b, #d97706);
    box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
  }
  
  .stat-number {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--text);
    line-height: 1;
    margin-bottom: 0.25rem;
  }
  
  .stat-label {
    font-size: 0.75rem;
    color: var(--muted);
    font-weight: 500;
    line-height: 1.2;
    margin-bottom: 0.25rem;
  }
  
  .stat-trend {
    font-size: 0.7rem;
    color: var(--muted);
    opacity: 0.8;
    font-weight: 400;
  }
  
  .filters-card {
    background: white;
    border-radius: 0.75rem;
    padding: 1.5rem;
    margin-bottom: 2rem;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
  }
  
  .filters-form {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)) auto;
    gap: 1rem;
    align-items: end;
  }
  
  .form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 500;
    color: var(--text);
  }
  
  .form-select {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #e9ecef;
    border-radius: 0.5rem;
    background: white;
    font-size: 0.9rem;
  }
  
  .events-section {
    background: white;
    border-radius: 0.75rem;
    padding: 1.5rem;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
  }
  
  .events-header {
    display: flex;
    align-items: center;
    margin-bottom: 1rem;
    gap: 0.5rem;
  }
  
  .events-header h3 {
    margin: 0;
    color: var(--text);
  }
  
  .empty-state {
    text-align: center;
    padding: 3rem 1rem;
    color: var(--muted);
  }
  
  .empty-state i {
    font-size: 3rem;
    margin-bottom: 1rem;
    opacity: 0.5;
  }
  
  .sync-status {
    display: inline-flex;
    align-items: center;
    padding: 0.25rem 0.75rem;
    border-radius: 1rem;
    font-size: 0.8rem;
    font-weight: 500;
  }
  
  .sync-status.ok {
    background: rgba(39, 174, 96, 0.1);
    color: var(--success);
  }
  
  .sync-status.error {
    background: rgba(231, 76, 60, 0.1);
    color: var(--danger);
  }
  
  .sync-status.pending {
    background: rgba(243, 156, 18, 0.1);
    color: var(--warning);
  }

  /* Responsividade */
  @media (max-width: 768px) {
    .stats-grid {
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    }
    
    .filters-form {
      grid-template-columns: 1fr;
    }
  }
</style>
{% endblock %}

{% block content %}
<div style="max-width: 1400px; margin: 0 auto;">
  <!-- Estatísticas -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-header">
        <div class="stat-icon">
          <i class="bi bi-calendar-event"></i>
        </div>
      </div>
      <div class="stat-number">{{ total_eventos }}</div>
      <div class="stat-label">Total de Eventos</div>
    </div>
    <div class="stat-card success">
      <div class="stat-header">
        <div class="stat-icon">
          <i class="bi bi-check-circle"></i>
        </div>
      </div>
      <div class="stat-number">{{ eventos_ok }}</div>
      <div class="stat-label">Sincronizados</div>
      {% if total_eventos > 0 %}
        <div class="stat-trend">{{ eventos_ok|floatformat:0 }}/{{ total_eventos }}</div>
      {% endif %}
    </div>
    <div class="stat-card danger">
      <div class="stat-header">
        <div class="stat-icon">
          <i class="bi bi-x-circle"></i>
        </div>
      </div>
      <div class="stat-number">{{ eventos_erro }}</div>
      <div class="stat-label">Com Erro</div>
      {% if total_eventos > 0 %}
        <div class="stat-trend">{{ eventos_erro|floatformat:0 }}/{{ total_eventos }}</div>
      {% endif %}
    </div>
    <div class="stat-card warning">
      <div class="stat-header">
        <div class="stat-icon">
          <i class="bi bi-clock"></i>
        </div>
      </div>
      <div class="stat-number">{{ eventos_pendentes }}</div>
      <div class="stat-label">Pendentes</div>
      {% if total_eventos > 0 %}
        <div class="stat-trend">{{ eventos_pendentes|floatformat:0 }}/{{ total_eventos }}</div>
      {% endif %}
    </div>
    <div class="stat-card">
      <div class="stat-header">
        <div class="stat-icon">
          <i class="bi bi-graph-up"></i>
        </div>
      </div>
      <div class="stat-number">{{ taxa_sucesso }}%</div>
      <div class="stat-label">Taxa de Sucesso</div>
      {% if total_eventos > 0 %}
        <div class="stat-trend">Últimos 7 dias</div>
      {% endif %}
    </div>
  </div>

  <!-- Filtros -->
  <div class="filters-card">
    <form method="get" class="filters-form">
      <div class="form-group">
        <label for="status">Status:</label>
        <select name="status" id="status" class="form-select">
          <option value="">Todos</option>
          <option value="OK" {% if request.GET.status == 'OK' %}selected{% endif %}>OK</option>
          <option value="Erro" {% if request.GET.status == 'Erro' %}selected{% endif %}>Erro</option>
          <option value="Pendente" {% if request.GET.status == 'Pendente' %}selected{% endif %}>Pendente</option>
        </select>
      </div>
      <div class="form-group">
        <label for="periodo">Período:</label>
        <select name="periodo" id="periodo" class="form-select">
          <option value="1" {% if request.GET.periodo == '1' %}selected{% endif %}>Último dia</option>
          <option value="7" {% if request.GET.periodo == '7' or not request.GET.periodo %}selected{% endif %}>Últimos 7 dias</option>
          <option value="30" {% if request.GET.periodo == '30' %}selected{% endif %}>Últimos 30 dias</option>
          <option value="90" {% if request.GET.periodo == '90' %}selected{% endif %}>Últimos 90 dias</option>
        </select>
      </div>
      <button type="submit" class="btn btn-primary">
        <i class="bi bi-funnel"></i> Filtrar
      </button>
    </form>
  </div>

  <!-- Lista de Eventos -->
  <div class="events-section">
    <div class="events-header">
      <i class="bi bi-calendar-event"></i>
      <h3>Eventos Sincronizados</h3>
      <span class="badge badge-primary">{{ eventos_sync|length }} registros</span>
    </div>
    
    {% if eventos_sync %}
      <div class="table-responsive">
        <table class="table">
          <thead>
            <tr>
              <th>Evento</th>
              <th>Data</th>
              <th>Status</th>
              <th>Criado em</th>
              <th>Usuário</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody>
            {% for evento in eventos_sync %}
            <tr>
              <td>
                <strong>{{ evento.solicitacao.titulo_evento|default:"Sem título" }}</strong>
                <br>
                <small class="text-muted">{{ evento.solicitacao.projeto.nome }} • {{ evento.solicitacao.municipio.nome }}</small>
              </td>
              <td>
                {{ evento.solicitacao.data_inicio|date:"d/m/Y H:i" }}
                <br>
                <small class="text-muted">até {{ evento.solicitacao.data_fim|date:"d/m/Y H:i" }}</small>
              </td>
              <td>
                {% if evento.status_sincronizacao == 'OK' %}
                  <span class="sync-status ok"><i class="bi bi-check-circle"></i> Sincronizado</span>
                {% elif evento.status_sincronizacao == 'Erro' %}
                  <span class="sync-status error"><i class="bi bi-x-circle"></i> Erro</span>
                {% else %}
                  <span class="sync-status pending"><i class="bi bi-clock"></i> Pendente</span>
                {% endif %}
              </td>
              <td>{{ evento.data_criacao|date:"d/m/Y H:i" }}</td>
              <td>{{ evento.usuario_criador.username }}</td>
              <td>
                {% if evento.html_link %}
                  <a href="{{ evento.html_link }}" target="_blank" class="btn btn-sm" title="Ver no Google Calendar">
                    <i class="bi bi-calendar-event"></i>
                  </a>
                {% endif %}
                {% if evento.meet_link %}
                  <a href="{{ evento.meet_link }}" target="_blank" class="btn btn-sm" title="Abrir Google Meet">
                    <i class="bi bi-camera-video"></i>
                  </a>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="empty-state">
        <i class="bi bi-calendar-x"></i>
        <p>Nenhum evento encontrado para os filtros selecionados.</p>
        <small>Os eventos aparecerão aqui após serem sincronizados com o Google Calendar.</small>
      </div>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block extra_js %}
document.addEventListener('DOMContentLoaded', function() {
  // Auto-refresh a cada 30 segundos
  const refreshBtn = document.getElementById('refresh-btn');
  if (refreshBtn) {
    refreshBtn.addEventListener('click', function() {
      location.reload();
    });
    
    // Auto-refresh
    setInterval(function() {
      location.reload();
    }, 30000); // 30 segundos
  }
});
{% endblock %}