{% load static %}
<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Dashboard Executivo — Diretoria</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/topojson@3"></script>
  <style>
    :root {
      --bg: linear-gradient(135deg, #213547 0%, #111827 100%);
      --content-bg: #f8fafc;
      --card: #ffffff;
      --text: #1f2937;
      --muted: #6b7280;
      --line: #e5e7eb;
      --accent: #2563eb;
      --accent-soft: rgba(37, 99, 235, 0.12);
      --success: #16a34a;
      --warning: #f59e0b;
      --danger: #dc2626;
      --shadow: 0 18px 45px rgba(15, 23, 42, 0.12);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      line-height: 1.6;
      min-height: 100vh;
    }

    .container {
      max-width: 1440px;
      margin: 0 auto;
      padding: 2.5rem;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .header {
      background: var(--card);
      border-radius: 1.5rem;
      padding: 2.5rem;
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .header h1 {
      font-size: 2.4rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .back-link {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      color: #bbdefb;
      text-decoration: none;
      font-weight: 600;
      align-self: flex-start;
    }

    .back-link:hover {
      color: white;
    }

    .filters-card {
      background: var(--card);
      border-radius: 1.2rem;
      padding: 1.8rem 2rem;
      box-shadow: var(--shadow);
    }

    .filters-form {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1.2rem;
      align-items: end;
    }

    .filters-form label {
      display: block;
      margin-bottom: 0.6rem;
      font-weight: 600;
      color: var(--muted);
      font-size: 0.95rem;
    }

    .filters-form select {
      width: 100%;
      padding: 0.8rem 1rem;
      border: 2px solid var(--line);
      border-radius: 0.75rem;
      font-size: 0.95rem;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
      background: var(--content-bg);
    }

    .filters-form select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 4px var(--accent-soft);
      outline: none;
    }

    .reset-button {
      background: var(--accent);
      color: white;
      border: none;
      padding: 0.85rem 1.4rem;
      border-radius: 0.75rem;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      justify-content: center;
      transition: background 0.2s ease;
    }

    .reset-button:hover {
      background: #1d4ed8;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1.5rem;
    }

    .stat-card {
      background: var(--card);
      padding: 1.8rem;
      border-radius: 1.2rem;
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: var(--accent);
    }

    .stat-card.success::before { background: var(--success); }
    .stat-card.warning::before { background: var(--warning); }
    .stat-card.danger::before { background: var(--danger); }

    .stat-card h3 {
      font-size: 2.2rem;
      font-weight: 700;
      color: var(--accent);
    }

    .stat-label {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .stat-footnote {
      font-size: 0.85rem;
      color: var(--muted);
    }

    .layout-two-cols {
      display: grid;
      grid-template-columns: 1.4fr 1fr;
      gap: 1.5rem;
    }

    @media (max-width: 1200px) {
      .layout-two-cols {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: var(--card);
      border-radius: 1.5rem;
      box-shadow: var(--shadow);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .card-header {
      padding: 1.5rem 1.8rem;
      border-bottom: 1px solid var(--line);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
    }

    .card-header h2 {
      font-size: 1.2rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .card-header small {
      color: var(--muted);
      font-size: 0.9rem;
    }

    .card-content {
      padding: 1.6rem;
      background: var(--content-bg);
    }

    /* Mapa ocupando toda a largura */
    .map-full-width {
      width: 100%;
      margin-bottom: 1.5rem;
    }

    /* Layout do mapa com painel lateral */
    .map-layout {
      display: flex;
      gap: 20px;
      align-items: flex-start;
    }

    .map-section {
      flex: 1;
      min-width: 0; /* Permite que o mapa se ajuste */
    }

    #mapWrapper {
      position: relative;
      width: 100%;
      min-height: 500px;
      overflow: hidden;
    }

    #brasilMap {
      width: 100%;
      height: 100%;
    }

    /* Estilos do mapa avançado */
    .state {
      transition: fill 0.3s ease;
    }

    .state:hover {
      fill: #3b82f6;
      stroke-width: 2;
      stroke: #1d4ed8;
    }
    .state.selected {
      fill: #6ee7b7;
      stroke: #10b981;
      stroke-width: 2;
    }
    .state.with-projects {
      fill: #10b981;
    }
    .state.with-projects:hover {
      fill: #059669;
    }
    .state.with-projects.selected {
      fill: #86efac;
    }
    .state.no-projects {
      fill: #d1d5db; /* Cinza claro para estados sem projetos */
    }
    .tooltip {
      position: absolute;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 12px;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s;
      z-index: 1000;
    }
    .tooltip.show {
      opacity: 1;
    }

    /* Estilos do painel lateral de detalhes */
    .state-detail {
      width: 350px;
      min-height: 500px;
      background: white;
      border: 1px solid #e5e7eb;
      padding: 20px;
      overflow-y: auto;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      border-radius: 8px;
      flex-shrink: 0; /* Não encolhe */
    }

    .state-detail.hidden {
      display: none;
    }

    .state-detail h3 {
      margin: 0 0 15px 0;
      color: #1f2937;
      font-size: 18px;
      font-weight: 600;
    }

    .state-detail h4 {
      margin: 20px 0 10px 0;
      color: #374151;
      font-size: 14px;
      font-weight: 500;
    }

    .state-info {
      margin-bottom: 20px;
      padding: 15px;
      background: #f9fafb;
      border-radius: 8px;
    }

    .state-name {
      font-size: 20px;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 5px;
    }

    .state-uf {
      font-size: 14px;
      color: #6b7280;
      font-weight: 500;
    }

    .municipality-list {
      max-height: 300px;
      overflow-y: auto;
    }

    .municipality-item {
      padding: 10px;
      margin-bottom: 8px;
      background: #f3f4f6;
      border-radius: 6px;
      border-left: 3px solid #10b981;
    }

    .municipality-name {
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 4px;
    }

    .municipality-stats {
      font-size: 12px;
      color: #6b7280;
    }

    .map-state {
      stroke: #ffffff;
      stroke-width: 1.2px;
      cursor: pointer;
      transition: fill 0.2s ease, transform 0.2s ease;
    }

    .map-state:hover {
      transform: scale(1.01);
      stroke: #1f2937;
    }

    .map-state.selected {
      stroke: #1f2937;
      stroke-width: 2.4px;
    }

    #mapLegend {
      position: absolute;
      bottom: 1rem;
      right: 1rem;
      display: flex;
      align-items: center;
      gap: 0.4rem;
      background: rgba(255, 255, 255, 0.9);
      padding: 0.6rem 0.8rem;
      border-radius: 999px;
      box-shadow: var(--shadow);
      font-size: 0.85rem;
    }

    .legend-step {
      width: 18px;
      height: 18px;
      border-radius: 4px;
    }

    .chart-content canvas {
      width: 100% !important;
      height: 360px !important;
    }

    .chart-breadcrumb {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      font-size: 0.9rem;
      color: var(--muted);
    }

    .chart-breadcrumb span {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
    }

    .coordenadores-card {
      background: var(--card);
      border-radius: 1rem;
      box-shadow: var(--shadow);
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      max-height: 500px;
      overflow-y: auto;
      position: relative;
    }

    .coordenadores-card::-webkit-scrollbar {
      width: 6px;
    }

    .coordenadores-card::-webkit-scrollbar-track {
      background: #f1f5f9;
      border-radius: 3px;
    }

    .coordenadores-card::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 3px;
    }

    .coordenadores-card::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }

    /* Indicador de scroll */
    .coordenadores-card::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 20px;
      background: linear-gradient(transparent, var(--card));
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .coordenadores-card.scrollable::after {
      opacity: 1;
    }

    .coordenadores-grid {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .municipio-group {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 0.75rem;
      overflow: hidden;
      margin-bottom: 0.5rem;
    }

    .municipio-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 0.75rem 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.9rem;
    }

    .municipio-header h3 {
      margin: 0;
      font-size: 0.95rem;
      font-weight: 600;
    }

    .municipio-stats {
      font-size: 0.8rem;
      opacity: 0.9;
      background: rgba(255, 255, 255, 0.2);
      padding: 0.25rem 0.5rem;
      border-radius: 0.5rem;
    }

    .coordenadores-municipio {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 0.5rem;
      padding: 0.75rem;
    }

    .coordenador-card {
      background: white;
      border-radius: 0.5rem;
      padding: 0.75rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      border: 1px solid #e2e8f0;
      transition: all 0.2s ease;
      min-height: 70px;
    }

    .coordenador-card:hover {
      border-color: #667eea;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
      transform: translateY(-1px);
    }

    .coordenador-card header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 0.5rem;
      margin-bottom: 0.25rem;
    }

    .coordenador-card strong {
      font-size: 0.85rem;
      font-weight: 600;
      line-height: 1.4;
      flex: 1;
      word-wrap: break-word;
      color: #2d3748;
    }

    .coordenador-card .badge {
      background: #667eea;
      color: white;
      padding: 0.2rem 0.5rem;
      border-radius: 0.5rem;
      font-size: 0.7rem;
      font-weight: 600;
      white-space: nowrap;
      flex-shrink: 0;
    }

    .coordenador-municipio {
      font-size: 0.75rem;
      color: #718096;
      font-weight: 500;
      margin-top: auto;
      word-wrap: break-word;
    }

    /* Melhorar espaçamento entre nomes múltiplos */
    .coordenador-card strong {
      line-height: 1.6;
    }

    .coordenador-card strong::after {
      content: '';
      display: block;
      height: 0.25rem;
    }

    /* Responsividade */
    @media (max-width: 768px) {
      .coordenadores-card {
        max-height: 400px;
        padding: 1rem;
      }
      
      .coordenadores-municipio {
        grid-template-columns: 1fr;
        gap: 0.5rem;
        padding: 0.5rem;
      }
      
      .municipio-header {
        padding: 0.5rem 0.75rem;
        font-size: 0.85rem;
      }
      
      .municipio-header h3 {
        font-size: 0.9rem;
      }
      
      .coordenador-card {
        padding: 0.5rem;
        min-height: 60px;
      }
      
      .coordenador-card strong {
        font-size: 0.8rem;
      }
      
      .coordenador-card .badge {
        font-size: 0.65rem;
        padding: 0.15rem 0.4rem;
      }
    }

    @media (max-width: 480px) {
      .coordenadores-card {
        max-height: 350px;
        padding: 0.75rem;
      }
      
      .municipio-group {
        margin-bottom: 0.25rem;
      }
      
      .municipio-header {
        padding: 0.5rem;
        flex-direction: column;
        align-items: flex-start;
        gap: 0.25rem;
      }
      
      .municipio-stats {
        font-size: 0.75rem;
      }
    }

    .municipio-header h3 {
      margin: 0;
      font-size: 1.1rem;
      font-weight: 600;
    }

    .municipio-stats {
      background: rgba(255, 255, 255, 0.2);
      padding: 0.3rem 0.8rem;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
    }

    .placeholder {
      color: var(--muted);
      font-style: italic;
    }

    .loading {
      opacity: 0.35;
      pointer-events: none;
      transition: opacity 0.2s ease;
    }

    .chips {
      display: flex;
      flex-wrap: wrap;
      gap: 0.6rem;
      font-size: 0.85rem;
      color: var(--muted);
    }

    .chip {
      background: var(--content-bg);
      border-radius: 999px;
      padding: 0.35rem 0.75rem;
      border: 1px solid var(--line);
    }

    .error-banner {
      background: rgba(220, 38, 38, 0.08);
      border: 1px solid rgba(248, 113, 113, 0.6);
      color: #991b1b;
      padding: 0.9rem 1.1rem;
      border-radius: 0.9rem;
      font-size: 0.95rem;
    }

    .error-banner[hidden] {
      display: none !important;
    }

    #mapFallback {
      position: absolute;
      inset: 0;
      display: grid;
      place-items: center;
      text-align: center;
      background: rgba(255, 255, 255, 0.92);
      backdrop-filter: blur(4px);
      border-radius: 1.2rem;
      padding: 1.5rem;
      font-weight: 600;
      color: var(--muted);
    }

    #mapFallback[hidden] {
      display: none;
    }
  </style>
</head>
<body>
  <div
    class="container"
    id="dashboard-root"
    data-geo-url="{% url 'core:api_mapa_estatisticas' %}"
    data-cursos-url="{% url 'core:diretoria_api_cursos' %}"
    data-coordenadores-url="{% url 'core:diretoria_api_coordenadores' %}"
    data-map-url="{% static 'brazil-states-topo.json' %}"
    data-periodo="{{ periodo_selecionado }}"
    data-municipio-id="{{ municipio_id_selecionado }}"
    data-municipio-nome="{{ municipio_nome_selecionado }}"
    data-uf="{{ uf_selecionada }}"
    data-regiao="{{ regiao_selecionada }}"
  >
    <a href="{% url 'core:home' %}" class="back-link">
      <i class="bi bi-arrow-left"></i> Voltar ao Dashboard
    </a>

    <div class="header">
      <h1><i class="bi bi-graph-up-arrow"></i> Dashboard Executivo</h1>
      <p>Visão estratégica do ecossistema — Atualizado para {{ ano_atual }} • {{ trimestre_atual }}</p>
      <div class="chips" id="activeFilters"></div>
    </div>

    <div id="globalError" class="error-banner" hidden></div>

    <section class="filters-card">
      <form id="dashboardFilters" class="filters-form">
        <div>
          <label for="municipioSelect"><i class="bi bi-geo-alt"></i> Município</label>
          <select id="municipioSelect" name="municipio_id">
            <option value="">Todos os municípios</option>
            {% for municipio in municipios_opcoes %}
            <option
              value="{{ municipio.id }}"
              data-nome="{{ municipio.nome }}"
              data-uf="{{ municipio.uf }}"
              {% if municipio.id == municipio_id_selecionado %}selected{% endif %}
            >
              {% if municipio.uf and municipio.uf in municipio.nome %}
                {{ municipio.nome }}
              {% elif municipio.uf %}
                {{ municipio.nome }} / {{ municipio.uf }}
              {% else %}
                {{ municipio.nome }}
              {% endif %}
            </option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label for="periodoSelect"><i class="bi bi-calendar-range"></i> Período</label>
          <select id="periodoSelect" name="periodo">
            <option value="6" {% if periodo_selecionado == 6 %}selected{% endif %}>Últimos 6 meses</option>
            <option value="12" {% if periodo_selecionado == 12 %}selected{% endif %}>Últimos 12 meses</option>
            <option value="24" {% if periodo_selecionado == 24 %}selected{% endif %}>Últimos 24 meses</option>
            <option value="36" {% if periodo_selecionado == 36 %}selected{% endif %}>Últimos 36 meses</option>
          </select>
        </div>
        <div>
          <button type="button" id="resetFilters" class="reset-button">
            <i class="bi bi-arrow-counterclockwise"></i> Limpar filtros
          </button>
        </div>
      </form>
    </section>

    <section class="stats-grid" id="statsGrid">
      <article class="stat-card">
        <span class="stat-label">Solicitações totais</span>
        <h3 id="metric-total-solicitacoes">--</h3>
        <span class="stat-footnote">No período selecionado</span>
      </article>
      <article class="stat-card success">
        <span class="stat-label">Eventos aprovados</span>
        <h3 id="metric-total-aprovadas">--</h3>
        <span class="stat-footnote">Aprovados vs. total</span>
      </article>
      <article class="stat-card">
        <span class="stat-label">Municípios ativos</span>
        <h3 id="metric-municipios-ativos">--</h3>
        <span class="stat-footnote">Cobertura territorial</span>
      </article>
      <article class="stat-card">
        <span class="stat-label">Coordenadores ativos</span>
        <h3 id="metric-coordenadores-ativos">--</h3>
        <span class="stat-footnote">Colaboradores engajados</span>
      </article>
      <article class="stat-card">
        <span class="stat-label">Formadores envolvidos</span>
        <h3 id="metric-formadores-ativos">--</h3>
        <span class="stat-footnote">Equipes mobilizadas</span>
      </article>
    </section>

    <!-- Mapa ocupando toda a largura -->
    <section class="card map-full-width">
      <header class="card-header">
        <h2><i class="bi bi-map"></i> Mapa Estratégico do Brasil</h2>
        <small>Clique em um estado para detalhar</small>
      </header>
      <div class="card-content map-layout">
        <div class="map-section">
          <div id="mapWrapper">
            <svg id="brasilMap" role="img" aria-label="Distribuição geográfica dos eventos aprovados"></svg>
            <div id="mapFallback" class="placeholder" hidden>Não foi possível carregar o mapa neste momento.</div>
            <div id="mapLegend" hidden></div>
          </div>
        </div>
        
        <!-- Painel lateral de detalhes do estado -->
        <div class="state-detail hidden" id="stateDetail">
          <h3>Detalhes do Estado</h3>
          <div class="state-info">
            <div class="state-name" id="stateName">-</div>
            <div class="state-uf" id="stateUF">-</div>
          </div>
          <h4>Municípios com Projetos:</h4>
          <div class="municipality-list" id="municipalityList">
            <p>Selecione um estado para ver os municípios</p>
          </div>
        </div>
      </div>
      
      <!-- Tooltip para o mapa avançado -->
      <div class="tooltip" id="tooltip"></div>
    </section>

    <!-- Gráfico de distribuição abaixo do mapa -->
    <section class="card">
      <header class="card-header">
        <div>
          <h2><i class="bi bi-bar-chart"></i> Distribuição de Cursos</h2>
          <div class="chart-breadcrumb" id="chartBreadcrumb">Brasil</div>
        </div>
        <small id="chartMeta">Carregando…</small>
      </header>
      <div class="card-content">
        <canvas id="cursosChart"></canvas>
      </div>
    </section>

    <section class="coordenadores-card">
      <header class="card-header" style="padding: 0; border-bottom: none;">
        <div>
          <h2><i class="bi bi-people"></i> Coordenadores por município</h2>
          <small>Acompanhe quem está liderando cada território</small>
        </div>
      </header>
      <div id="coordenadoresList" class="coordenadores-grid">
        <p class="placeholder">Carregando dados...</p>
      </div>
    </section>
  </div>

  <template id="coordenadorTemplate">
    <article class="coordenador-card">
      <header>
        <strong class="coordenador-nome"></strong>
        <span class="badge coordenador-eventos"></span>
      </header>
    </article>
  </template>

  <template id="municipioGroupTemplate">
    <div class="municipio-group">
      <div class="municipio-header">
        <h3 class="municipio-nome"></h3>
        <span class="municipio-stats"></span>
      </div>
      <div class="coordenadores-municipio"></div>
    </div>
  </template>

  <script>
    const root = document.getElementById('dashboard-root');
    const state = {
      periodo: Number(root.dataset.periodo || 12),
      regiao: root.dataset.regiao || null,
      uf: root.dataset.uf || null,
      municipioId: root.dataset.municipioId || null,
      municipioNome: root.dataset.municipioNome || null,
    };

    const endpoints = {
      geo: root.dataset.geoUrl,
      cursos: root.dataset.cursosUrl,
      coordenadores: root.dataset.coordenadoresUrl,
    };
    const mapAssets = {
      topo: root.dataset.mapUrl,
      fallbackRemote: 'https://raw.githubusercontent.com/deldersveld/topojson/master/countries/brazil/brazil-states.json',
    };

    const numberFormatter = new Intl.NumberFormat('pt-BR');

    const UF_TO_REGION = {
      AC: 'Norte', AL: 'Nordeste', AP: 'Norte', AM: 'Norte', BA: 'Nordeste', CE: 'Nordeste', DF: 'Centro-Oeste',
      ES: 'Sudeste', GO: 'Centro-Oeste', MA: 'Nordeste', MT: 'Centro-Oeste', MS: 'Centro-Oeste', MG: 'Sudeste',
      PA: 'Norte', PB: 'Nordeste', PR: 'Sul', PE: 'Nordeste', PI: 'Nordeste', RJ: 'Sudeste', RN: 'Nordeste',
      RS: 'Sul', RO: 'Norte', RR: 'Norte', SC: 'Sul', SP: 'Sudeste', SE: 'Nordeste', TO: 'Norte'
    };

    const STATE_TO_UF = {
      'Acre': 'AC', 'Alagoas': 'AL', 'Amapá': 'AP', 'Amazonas': 'AM', 'Bahia': 'BA', 'Ceará': 'CE',
      'Distrito Federal': 'DF', 'Espírito Santo': 'ES', 'Goiás': 'GO', 'Maranhão': 'MA', 'Mato Grosso': 'MT',
      'Mato Grosso do Sul': 'MS', 'Minas Gerais': 'MG', 'Pará': 'PA', 'Paraíba': 'PB', 'Paraná': 'PR',
      'Pernambuco': 'PE', 'Piauí': 'PI', 'Rio de Janeiro': 'RJ', 'Rio Grande do Norte': 'RN',
      'Rio Grande do Sul': 'RS', 'Rondônia': 'RO', 'Roraima': 'RR', 'Santa Catarina': 'SC',
      'São Paulo': 'SP', 'Sergipe': 'SE', 'Tocantins': 'TO'
    };

    let cursosChart;
    let brasilFeatures = null;

    function setLoading(isLoading) {
      document.body.classList.toggle('loading', isLoading);
    }

    function showGlobalError(message) {
      const banner = document.getElementById('globalError');
      if (!banner) return;
      banner.textContent = message;
      banner.hidden = false;
    }

    function clearGlobalError() {
      const banner = document.getElementById('globalError');
      if (!banner) return;
      banner.hidden = true;
      banner.textContent = '';
    }

    function showMapFallback(message) {
      const fallback = document.getElementById('mapFallback');
      const legend = document.getElementById('mapLegend');
      if (fallback) {
        fallback.textContent = message;
        fallback.hidden = false;
      }
      if (legend) {
        legend.hidden = true;
      }
    }

    function hideMapFallback() {
      const fallback = document.getElementById('mapFallback');
      if (fallback) {
        fallback.hidden = true;
      }
    }

    async function fetchJSON(url, params = {}) {
      const query = new URLSearchParams({ ...params });
      const response = await fetch(`${url}?${query.toString()}`, { credentials: 'same-origin' });
      if (!response.ok) {
        throw new Error(`Erro ao carregar dados (${response.status})`);
      }
      return response.json();
    }

    function buildParams(extra = {}) {
      const params = {
        periodo: state.periodo,
      };
      if (state.regiao) params.regiao = state.regiao;
      if (state.uf) params.uf = state.uf;
      if (state.municipioId) params.municipio_id = state.municipioId;
      if (state.municipioNome && !state.municipioId) params.municipio = state.municipioNome;
      return { ...params, ...extra };
    }

    function updateStats(summary) {
      const map = {
        'metric-total-solicitacoes': summary.total_solicitacoes,
        'metric-total-aprovadas': summary.total_solicitacoes, // Usando total_solicitacoes como aprovadas
        'metric-taxa-aprovacao': '100%', // Assumindo 100% já que só contamos aprovadas
        'metric-total-pendentes': 0, // Não temos dados de pendentes
        'metric-total-reprovadas': 0, // Não temos dados de reprovadas
        'metric-municipios-ativos': summary.municipios_com_projetos,
        'metric-coordenadores-ativos': 0, // Não temos dados de coordenadores
        'metric-formadores-ativos': 0, // Não temos dados de formadores
      };

      Object.entries(map).forEach(([id, value]) => {
        const el = document.getElementById(id);
        if (!el) return;
        if (typeof value === 'number') {
          el.textContent = numberFormatter.format(value);
        } else {
          el.textContent = value ?? '--';
        }
      });
    }

    function updateActiveFilters() {
      const wrapper = document.getElementById('activeFilters');
      wrapper.innerHTML = '';
      const chips = [];
      if (state.regiao) chips.push(`Região: ${state.regiao}`);
      if (state.uf) chips.push(`UF: ${state.uf}`);
      if (state.municipioNome) chips.push(`Município: ${state.municipioNome}`);
      if (!chips.length) {
        wrapper.innerHTML = '<span class="chip">Brasil completo</span>';
        return;
      }
      chips.forEach(text => {
        const span = document.createElement('span');
        span.className = 'chip';
        span.textContent = text;
        wrapper.appendChild(span);
      });
    }

    async function loadTopoJSON(url) {
      const response = await fetch(url, { credentials: 'same-origin' });
      if (!response.ok) {
        throw new Error(`TopoJSON fetch failed (${response.status})`);
      }
      const topo = await response.json();
      if (topo.type === 'FeatureCollection') {
        return topo;
      }
      const objectName = topo.objects?.states
        ? 'states'
        : Object.keys(topo.objects || {})[0];
      if (!objectName) {
        throw new Error('TopoJSON without geometries');
      }
      return topojson.feature(topo, topo.objects[objectName]);
    }

    async function ensureMapData() {
      if (brasilFeatures) return brasilFeatures;
      try {
        brasilFeatures = await loadTopoJSON(mapAssets.topo);
      } catch (localError) {
        console.warn('Mapa local indisponível, tentando fonte remota...', localError);
        try {
          brasilFeatures = await loadTopoJSON(mapAssets.fallbackRemote);
        } catch (remoteError) {
          console.error('Falha ao obter mapa remoto', remoteError);
          throw localError;
        }
      }
      return brasilFeatures;
    }

    function renderLegend(maxValue) {
      const legend = document.getElementById('mapLegend');
      if (!maxValue || maxValue === 0) {
        legend.hidden = true;
        legend.innerHTML = '';
        return;
      }
      const steps = 5;
      const scale = d3.scaleSequential(d3.interpolateBlues).domain([0, maxValue]);
      legend.hidden = false;
      legend.innerHTML = '';
      for (let i = 0; i <= steps; i += 1) {
        const value = (maxValue / steps) * i;
        const step = document.createElement('span');
        step.className = 'legend-step';
        step.style.background = scale(value);
        legend.appendChild(step);
      }
      const caption = document.createElement('span');
      caption.textContent = `${numberFormatter.format(0)} — ${numberFormatter.format(maxValue)} eventos`;
      legend.appendChild(caption);
    }

    // Variáveis globais para o mapa avançado
    let projectData = {};
    let svg, projection, path, states, tooltip;
    let selectedState = null;
    let originalProjection = null;
    let estatisticas = {};
    let isAnimating = false;

    // Carregar dados reais da API
    async function loadProjectData() {
      try {
        console.log('🔄 Carregando dados reais do banco...');
        
        const response = await fetch('/api/mapa/dados/');
        if (!response.ok) {
          throw new Error(`Erro HTTP: ${response.status}`);
        }
        
        projectData = await response.json();
        console.log(`✅ Dados carregados: ${Object.keys(projectData).length} estados com projetos`);
        
        // Carregar estatísticas
        const statsResponse = await fetch('/api/mapa/estatisticas/');
        if (statsResponse.ok) {
          estatisticas = await statsResponse.json();
          console.log(`📊 Estatísticas: ${estatisticas.municipios_com_projetos} municípios, ${estatisticas.total_solicitacoes} solicitações`);
        }
        
        return projectData;
      } catch (error) {
        console.error('❌ Erro ao carregar dados:', error);
        return {};
      }
    }

    // Função para selecionar estado
    function selectState(stateName, stateData) {
      console.log(`🖱️ Estado selecionado: ${stateName}`);
      
      // Remover seleção anterior
      states.classed('selected', false);
      
      // Selecionar novo estado
      states.filter(d => (d.properties.name || d.properties.NAME) === stateName)
        .classed('selected', true);
      
      // Atualizar detalhes do estado
      updateStateDetail(stateName);
      
      // Zoom no estado
      zoomToState(stateData);
    }

    // Função para atualizar detalhes do estado
    function updateStateDetail(stateName) {
      const stateData = projectData[stateName];
      const stateDetail = document.getElementById('stateDetail');
      const stateNameEl = document.getElementById('stateName');
      const stateUFEl = document.getElementById('stateUF');
      const municipalityList = document.getElementById('municipalityList');
      
      if (stateData) {
        console.log(`📊 Estado ${stateName}: ${stateData.projects} projetos, ${stateData.solicitacoes} solicitações`);
        
        // Mostrar painel lateral
        stateDetail.classList.remove('hidden');
        
        // Atualizar informações do estado
        stateNameEl.textContent = stateName;
        stateUFEl.textContent = stateData.uf;
        
        // Atualizar lista de municípios
        municipalityList.innerHTML = '';
        
        if (stateData.municipalities && stateData.municipalities.length > 0) {
          stateData.municipalities.forEach(municipality => {
            const item = document.createElement('div');
            item.className = 'municipality-item';
            item.innerHTML = `
              <div class="municipality-name">${municipality.name}</div>
              <div class="municipality-stats">
                ${municipality.projects} projetos • ${municipality.solicitacoes} solicitações
              </div>
            `;
            municipalityList.appendChild(item);
          });
        } else {
          municipalityList.innerHTML = '<p>Nenhum município com projetos encontrado</p>';
        }
      } else {
        // Estado sem projetos
        stateDetail.classList.remove('hidden');
        stateNameEl.textContent = stateName;
        stateUFEl.textContent = '';
        municipalityList.innerHTML = '<p>Este estado não possui projetos ativos</p>';
      }
    }

    // Função para zoom no estado
    function zoomToState(stateData) {
      if (isAnimating) return;
      
      isAnimating = true;
      svg.style('cursor', 'wait');
      console.log('🔍 Fazendo zoom no estado selecionado');
      
      // Calcular centro do estado
      const centroid = d3.geoCentroid(stateData);
      
      // Criar nova projeção para o estado
      const newProjection = d3.geoMercator()
        .scale(2000)
        .center(centroid)
        .translate([500, 400]);
      
      const newPath = d3.geoPath().projection(newProjection);
      
      // Aplicar transição suave com easing aos estados
      states.transition()
        .duration(600)
        .ease(d3.easeCubicInOut)
        .attr('d', newPath);
      
      // Adicionar botão de reset após a transição
      setTimeout(() => {
        addResetButton();
        svg.style('cursor', 'default');
        isAnimating = false;
      }, 650);
    }

    // Função para adicionar botão de reset
    function addResetButton() {
      // Remover botão anterior se existir
      d3.select('#resetButton').remove();
      
      // Adicionar botão de reset
      const resetButton = svg.append('g')
        .attr('id', 'resetButton')
        .style('cursor', 'pointer');
      
      resetButton.append('rect')
        .attr('x', 1020) // Canto superior direito ajustado
        .attr('y', 20)
        .attr('width', 140)
        .attr('height', 40)
        .attr('fill', '#007bff')
        .attr('rx', 6);
      
      resetButton.append('text')
        .attr('x', 1090) // Centro do botão no canto direito
        .attr('y', 42)
        .attr('text-anchor', 'middle')
        .attr('fill', 'white')
        .attr('font-size', '14px')
        .attr('font-weight', 'bold')
        .text('Voltar ao Brasil');
      
      resetButton.on('click', resetZoom);
    }

    // Função para resetar zoom
    function resetZoom() {
      if (isAnimating) return;
      
      isAnimating = true;
      svg.style('cursor', 'wait');
      console.log('🔄 Resetando zoom para visualização completa');
      
      // Remover botão de reset
      d3.select('#resetButton').remove();
      
      // Resetar projeção para a original
      projection = d3.geoMercator()
        .scale(originalProjection.scale)
        .center(originalProjection.center)
        .translate(originalProjection.translate);
      
      path = d3.geoPath().projection(projection);
      
      // Aplicar transição suave com easing aos estados
      states.transition()
        .duration(600)
        .ease(d3.easeCubicInOut)
        .attr('d', path);
      
      // Remover seleção
      states.classed('selected', false);
      selectedState = null;
      
      // Esconder painel lateral
      const stateDetail = document.getElementById('stateDetail');
      if (stateDetail) {
        stateDetail.classList.add('hidden');
      }
      
      setTimeout(() => {
        svg.style('cursor', 'default');
        isAnimating = false;
      }, 650);
    }

    async function drawMap(geoData) {
      try {
        console.log('🔄 Carregando mapa avançado...');
        
        // Carregar dados reais
        await loadProjectData();
        
        const mapContainer = d3.select('#brasilMap');
        const wrapper = mapContainer.node();
        const width = wrapper.clientWidth || 720;
        const height = 520;
        
        // Configurar SVG
        svg = mapContainer
          .attr('viewBox', '0 0 1200 600'); // Aumentado para mostrar o Brasil completo
        
        console.log('📐 SVG configurado');
        
        // Criar projeção Mercator manual (mais confiável)
        console.log('🎯 Criando projeção Mercator manual...');
        
        projection = d3.geoMercator()
          .scale(600)
          .center([-54, -14])
          .translate([600, 300]);
        
        // Salvar projeção original
        originalProjection = {
          scale: projection.scale(),
          center: projection.center(),
          translate: projection.translate()
        };
        
        path = d3.geoPath().projection(projection);
        
        console.log('✅ Projeção Mercator criada com sucesso');
        console.log('✅ Path generator criado com projeção Mercator');
        
        // Carregar dados do GeoJSON
        const geoDataResponse = await fetch('/static/brazil-real.geojson');
        if (!geoDataResponse.ok) {
          throw new Error(`Erro ao carregar GeoJSON: ${geoDataResponse.status}`);
        }
        
        const geoData = await geoDataResponse.json();
        console.log('✅ Arquivo GeoJSON carregado com sucesso');
        console.log('📊 GeoJSON parseado:', geoData.type);
        console.log('🗺️ Features encontradas:', geoData.features.length);
        
        // Criar tooltip
        tooltip = d3.select('#tooltip');
        
        // Renderizar estados
        states = svg.selectAll('path.state')
          .data(geoData.features)
          .enter()
          .append('path')
          .attr('class', function(d) {
            const stateName = d.properties.name || d.properties.NAME || '';
            const hasProjects = projectData[stateName] && projectData[stateName].projects > 0;
            return hasProjects ? 'state with-projects' : 'state no-projects';
          })
          .attr('d', function(d) {
            try {
              const pathData = path(d);
              if (!pathData || pathData.includes('NaN')) {
                console.log(`⚠️ Path inválido para ${d.properties.name || 'Estado'}: ${pathData}`);
                return null;
              }
              return pathData;
            } catch (error) {
              console.log(`❌ Erro ao gerar path para ${d.properties.name || 'Estado'}: ${error.message}`);
              return null;
            }
          })
          .on('mouseover', function(event, d) {
            const stateName = d.properties.name || d.properties.NAME || 'Estado';
            const stateData = projectData[stateName];
            
            tooltip
              .html(`
                <strong>${stateName}</strong><br/>
                ${stateData ? `${stateData.projects} projetos` : 'Sem projetos'}
              `)
              .style('left', (event.pageX + 10) + 'px')
              .style('top', (event.pageY - 10) + 'px')
              .classed('show', true);
          })
          .on('mouseout', function() {
            tooltip.classed('show', false);
          })
          .on('click', function(event, d) {
            const stateName = d.properties.name || d.properties.NAME || 'Estado';
            selectState(stateName, d);
          });
        
        console.log(`🎨 ${states.size()} estados renderizados`);
        
        // Atualizar tooltip de município selelecionado
        const chartMeta = document.getElementById('chartMeta');
        chartMeta.textContent = `${estatisticas.total_solicitacoes || 0} solicitações aprovadas`;
        
        console.log('🎉 Mapa avançado renderizado com sucesso!');
        
      } catch (error) {
        console.error(`❌ Erro ao carregar mapa: ${error.message}`);
      }
    }

    function initChart() {
      const ctx = document.getElementById('cursosChart').getContext('2d');
      cursosChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: [],
          datasets: [
            {
              label: 'Eventos',
              data: [],
              backgroundColor: '#2563eb',
              borderRadius: 12,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label(context) {
                  return `${context.parsed.y} eventos`;
                },
              },
            },
          },
          scales: {
            x: {
              ticks: { color: '#6b7280' },
              grid: { display: false },
            },
            y: {
              ticks: { color: '#6b7280' },
              grid: { color: '#e5e7eb' },
              beginAtZero: true,
            },
          },
        },
      });
    }

    function updateChart(data) {
      const labels = data.series.map(item => item.label);
      const values = data.series.map(item => item.value);
      cursosChart.data.labels = labels;
      cursosChart.data.datasets[0].data = values;
      cursosChart.update();

      const breadcrumb = document.getElementById('chartBreadcrumb');
      const parts = [];
      if (data.level === 'regiao') {
        parts.push('Brasil');
      }
      if (state.regiao && data.level !== 'regiao') {
        parts.push(state.regiao);
      }
      if (state.uf && data.level !== 'regiao') {
        parts.push(state.uf);
      }
      if (state.municipioNome && data.level === 'projeto') {
        parts.push(state.municipioNome);
      }
      breadcrumb.textContent = parts.length ? parts.join(' → ') : 'Brasil';

      const meta = document.getElementById('chartMeta');
      const total = numberFormatter.format(data.total_eventos || 0);
      const label = data.level === 'projeto' ? 'projetos' : data.level === 'municipio' ? 'municípios' : 'regiões';
      meta.textContent = `${total} eventos distribuídos em ${label}`;
    }

    function renderCoordenadores(data) {
      const wrapper = document.getElementById('coordenadoresList');
      wrapper.innerHTML = '';
      const coordTemplate = document.getElementById('coordenadorTemplate');
      const municipioGroupTemplate = document.getElementById('municipioGroupTemplate');

      if (!data.municipios.length) {
        wrapper.innerHTML = '<p class="placeholder">Nenhum coordenador encontrado para este recorte.</p>';
        return;
      }

      data.municipios.forEach(entry => {
        // Criar grupo do município
        const municipioGroup = municipioGroupTemplate.content.cloneNode(true);
        
        // Configurar cabeçalho do município (sem pin e sem repetir UF)
        const municipioNome = municipioGroup.querySelector('.municipio-nome');
        municipioNome.textContent = `${entry.municipio} - ${entry.uf}`;
        
        const municipioStats = municipioGroup.querySelector('.municipio-stats');
        municipioStats.textContent = `${entry.total_eventos_municipio} eventos • ${entry.total_coordenadores} coordenadores`;
        
        // Container para coordenadores do município
        const coordenadoresContainer = municipioGroup.querySelector('.coordenadores-municipio');
        
        // Adicionar coordenadores do município
        entry.coordenadores.forEach(coord => {
          const clone = coordTemplate.content.cloneNode(true);
          
          // Melhorar espaçamento entre nomes múltiplos
          const nomeElement = clone.querySelector('.coordenador-nome');
          const nomeCompleto = coord.nome || 'Coordenador';
          
          // Se há múltiplos nomes separados por " - ", adicionar quebras de linha
          if (nomeCompleto.includes(' - ')) {
            nomeElement.innerHTML = nomeCompleto.split(' - ').join('<br>');
          } else {
            nomeElement.textContent = nomeCompleto;
          }
          
          clone.querySelector('.coordenador-eventos').textContent = `${coord.eventos} eventos`;
          coordenadoresContainer.appendChild(clone);
        });
        
        wrapper.appendChild(municipioGroup);
      });
      
      // Detectar se há scroll e mostrar indicador
      const coordenadoresCard = document.querySelector('.coordenadores-card');
      if (coordenadoresCard) {
        const checkScroll = () => {
          const isScrollable = coordenadoresCard.scrollHeight > coordenadoresCard.clientHeight;
          coordenadoresCard.classList.toggle('scrollable', isScrollable);
        };
        
        checkScroll();
        coordenadoresCard.addEventListener('scroll', checkScroll);
        window.addEventListener('resize', checkScroll);
      }
    }

    async function loadGeo() {
      console.log('🔄 Iniciando loadGeo...');
      try {
        // Carregar estatísticas para os cartões
        const statsData = await fetchJSON(endpoints.geo, buildParams());
        console.log('✅ Dados de estatísticas recebidos:', statsData);
        updateStats(statsData);
        updateActiveFilters();
        
        // Carregar dados do mapa separadamente
        const mapData = await fetchJSON('/api/mapa/dados/', buildParams());
        console.log('✅ Dados do mapa recebidos:', mapData);
        await drawMap(mapData);
        console.log('✅ Mapa renderizado com sucesso');
        return statsData;
      } catch (error) {
        console.error('❌ Falha ao renderizar o mapa estratégico', error);
        console.error('❌ Detalhes do erro:', error.message, error.stack);
        showMapFallback(`Erro ao carregar mapa: ${error.message}`);
        return {};
      }
    }

    async function loadCursos() {
      const data = await fetchJSON(endpoints.cursos, buildParams());
      updateChart(data);
    }

    async function loadCoordenadores() {
      const data = await fetchJSON(endpoints.coordenadores, buildParams());
      renderCoordenadores(data);
    }

    async function refreshDashboard() {
      setLoading(true);
      clearGlobalError();
      try {
        await loadGeo();
        await Promise.all([loadCursos(), loadCoordenadores()]);
      } catch (error) {
        console.error('Falha ao carregar o dashboard executivo', error);
        showGlobalError('Não foi possível carregar os dados do dashboard executivo. Atualize a página ou tente novamente em instantes.');
      } finally {
        setLoading(false);
      }
    }

    function setupFilters() {
      const periodoSelect = document.getElementById('periodoSelect');
      const municipioSelect = document.getElementById('municipioSelect');
      const resetButton = document.getElementById('resetFilters');

      periodoSelect.addEventListener('change', event => {
        state.periodo = Number(event.target.value);
        refreshDashboard();
      });

      municipioSelect.addEventListener('change', event => {
        const option = event.target.selectedOptions[0];
        const value = option ? option.value : '';
        if (!value) {
          state.municipioId = null;
          state.municipioNome = null;
          state.uf = null;
        } else {
          state.municipioId = value;
          state.municipioNome = option.dataset.nome;
          state.uf = option.dataset.uf || null;
          state.regiao = state.uf ? (UF_TO_REGION[state.uf] || null) : null;
        }
        refreshDashboard();
      });

      resetButton.addEventListener('click', () => {
        state.periodo = 12;
        state.regiao = null;
        state.uf = null;
        state.municipioId = null;
        state.municipioNome = null;
        periodoSelect.value = '12';
        municipioSelect.value = '';
        refreshDashboard();
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      console.log('🚀 DOM carregado, iniciando dashboard...');
      initChart();
      setupFilters();
      refreshDashboard();
    });
  </script>
</body>
</html>
