{% extends "core/base.html" %}
{% load static %}

{% block title %}Logs de Comunicação - Sistema Aprender{% endblock %}

{% block page_title %}Logs de Comunicação{% endblock %}

{% block breadcrumb %}
<a href="{% url 'core:home' %}">Home</a> / 
<a href="/admin/">Administração</a> / 
Logs de Comunicação
{% endblock %}

{% block head %}
<style>
  .log-item {
    border-left: 4px solid #dee2e6;
    transition: all 0.2s ease;
  }
  
  .log-item.enviado {
    border-left-color: #28a745;
  }
  
  .log-item.falhado {
    border-left-color: #dc3545;
  }
  
  .log-item.pendente {
    border-left-color: #ffc107;
  }
  
  .log-item:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }
  
  .stats-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 12px;
    padding: 1.5rem;
  }
  
  .stats-number {
    font-size: 2rem;
    font-weight: bold;
    margin-bottom: 0.5rem;
  }
  
  .badge-tipo {
    font-size: 0.75rem;
    padding: 0.35rem 0.65rem;
  }
  
  .log-content {
    font-size: 0.9rem;
    line-height: 1.4;
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
  
  <!-- Estatísticas -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="stats-card">
        <div class="stats-number" id="totalLogs">-</div>
        <div>Total de Comunicações</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center h-100">
        <div class="card-body">
          <div class="stats-number text-success" id="totalEnviado">-</div>
          <div class="text-muted">Enviadas</div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center h-100">
        <div class="card-body">
          <div class="stats-number text-danger" id="totalFalhado">-</div>
          <div class="text-muted">Falhadas</div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center h-100">
        <div class="card-body">
          <div class="stats-number text-warning" id="totalPendente">-</div>
          <div class="text-muted">Pendentes</div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Filtros -->
  <div class="card mb-4">
    <div class="card-header">
      <i class="bi bi-funnel"></i> Filtros
    </div>
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-3">
          <label class="form-label">Tipo de Comunicação</label>
          <select class="form-select" id="filterTipo">
            <option value="">Todos os tipos</option>
            <option value="notificacao_sistema">Notificação do Sistema</option>
            <option value="email">E-mail</option>
            <option value="sms">SMS</option>
            <option value="whatsapp">WhatsApp</option>
            <option value="push_notification">Push Notification</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">Status</label>
          <select class="form-select" id="filterStatus">
            <option value="">Todos os status</option>
            <option value="enviado">Enviado</option>
            <option value="falhado">Falhado</option>
            <option value="pendente">Pendente</option>
            <option value="cancelado">Cancelado</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">Usuário</label>
          <input type="text" class="form-control" id="filterUser" placeholder="Buscar por usuário...">
        </div>
        <div class="col-md-3">
          <label class="form-label">&nbsp;</label>
          <div>
            <button class="btn btn-primary" onclick="loadLogs()">
              <i class="bi bi-search"></i> Filtrar
            </button>
            <button class="btn btn-outline-secondary" onclick="clearFilters()">
              <i class="bi bi-x-circle"></i> Limpar
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Loading -->
  <div class="text-center py-5" id="logsLoading">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Carregando logs...</span>
    </div>
  </div>
  
  <!-- Lista de Logs -->
  <div class="card">
    <div class="card-header">
      <i class="bi bi-list-ul"></i> Logs de Comunicação
      <span class="badge bg-primary ms-2" id="logsCount">0</span>
    </div>
    <div class="card-body">
      <div id="logsList">
        <!-- Logs serão carregados via JavaScript -->
      </div>
      
      <!-- Paginação -->
      <div class="text-center mt-4">
        <button class="btn btn-outline-primary" id="loadMoreBtn" onclick="loadMoreLogs()" style="display: none;">
          <i class="bi bi-arrow-down-circle"></i> Carregar Mais
        </button>
      </div>
    </div>
  </div>
  
</div>

<script>
class CommunicationLogsViewer {
  constructor() {
    this.offset = 0;
    this.limit = 20;
    this.hasMore = false;
    this.init();
  }
  
  init() {
    this.loadStats();
    this.loadLogs();
  }
  
  async loadStats() {
    try {
      const response = await fetch('/api/communications/stats/', {
        headers: {
          'X-CSRFToken': this.getCSRFToken()
        }
      });
      
      const data = await response.json();
      
      if (data.success) {
        const stats = data.stats;
        
        document.getElementById('totalLogs').textContent = stats.total_comunicacoes;
        document.getElementById('totalEnviado').textContent = stats.por_status.enviado || 0;
        document.getElementById('totalFalhado').textContent = stats.por_status.falhado || 0;
        document.getElementById('totalPendente').textContent = stats.por_status.pendente || 0;
      }
      
    } catch (error) {
      console.error('Erro ao carregar estatísticas:', error);
    }
  }
  
  async loadLogs(reset = false) {
    if (reset) {
      this.offset = 0;
    }
    
    try {
      const params = new URLSearchParams({
        limit: this.limit,
        offset: this.offset
      });
      
      // Filtros
      const tipo = document.getElementById('filterTipo').value;
      const status = document.getElementById('filterStatus').value;
      const user = document.getElementById('filterUser').value;
      
      if (tipo) params.append('type', tipo);
      if (status) params.append('status', status);
      if (user) params.append('user', user);
      
      const response = await fetch(`/api/communications/logs/?${params}`, {
        headers: {
          'X-CSRFToken': this.getCSRFToken()
        }
      });
      
      const data = await response.json();
      
      if (data.success) {
        if (reset) {
          this.renderLogs(data.logs);
        } else {
          this.appendLogs(data.logs);
        }
        
        this.hasMore = data.has_more;
        document.getElementById('loadMoreBtn').style.display = this.hasMore ? 'block' : 'none';
        document.getElementById('logsCount').textContent = data.total_count;
        
        this.offset += data.logs.length;
      }
      
    } catch (error) {
      console.error('Erro ao carregar logs:', error);
    } finally {
      document.getElementById('logsLoading').style.display = 'none';
    }
  }
  
  renderLogs(logs) {
    const container = document.getElementById('logsList');
    container.innerHTML = this.generateLogsHTML(logs);
  }
  
  appendLogs(logs) {
    const container = document.getElementById('logsList');
    container.insertAdjacentHTML('beforeend', this.generateLogsHTML(logs));
  }
  
  generateLogsHTML(logs) {
    if (logs.length === 0) {
      return '<div class="text-center py-4 text-muted"><i class="bi bi-inbox"></i><br>Nenhum log encontrado</div>';
    }
    
    return logs.map(log => `
      <div class="log-item card mb-3 ${log.status}">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <div>
              <span class="badge badge-tipo ${this.getBadgeClass(log.tipo)}">${log.tipo_display}</span>
              <span class="badge ${this.getStatusBadgeClass(log.status)} ms-2">${log.status_display}</span>
            </div>
            <small class="text-muted">${new Date(log.created_at).toLocaleString('pt-BR')}</small>
          </div>
          
          <h6 class="card-title">${log.assunto}</h6>
          
          <div class="row">
            <div class="col-md-6">
              <div class="log-content">
                <strong>Destinatário:</strong><br>
                ${log.destinatario ? `
                  ${log.destinatario.nome || log.destinatario.username}<br>
                  <small class="text-muted">${log.destinatario.email || ''}</small>
                ` : log.grupo_destinatario || 'N/A'}
              </div>
            </div>
            <div class="col-md-6">
              <div class="log-content">
                <strong>Endereço:</strong> ${log.endereco_destinatario || 'N/A'}<br>
                ${log.enviado_em ? `<strong>Enviado em:</strong> ${new Date(log.enviado_em).toLocaleString('pt-BR')}` : ''}
              </div>
            </div>
          </div>
          
          <div class="mt-3">
            <strong>Conteúdo:</strong>
            <div class="log-content p-2 bg-light rounded">
              ${log.conteudo}
            </div>
          </div>
          
          ${log.erro_envio ? `
            <div class="mt-2">
              <strong class="text-danger">Erro:</strong>
              <div class="text-danger small">${log.erro_envio}</div>
            </div>
          ` : ''}
          
          ${log.entidade_relacionada ? `
            <div class="mt-2">
              <small class="text-muted">
                Relacionado: ${log.entidade_relacionada.tipo} 
                (ID: ${log.entidade_relacionada.id})
              </small>
            </div>
          ` : ''}
        </div>
      </div>
    `).join('');
  }
  
  getBadgeClass(tipo) {
    const classes = {
      'notificacao_sistema': 'bg-primary',
      'email': 'bg-info',
      'sms': 'bg-warning',
      'whatsapp': 'bg-success',
      'push_notification': 'bg-secondary'
    };
    return classes[tipo] || 'bg-secondary';
  }
  
  getStatusBadgeClass(status) {
    const classes = {
      'enviado': 'bg-success',
      'falhado': 'bg-danger',
      'pendente': 'bg-warning',
      'cancelado': 'bg-secondary'
    };
    return classes[status] || 'bg-secondary';
  }
  
  getCSRFToken() {
    const token = document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
                  document.querySelector('meta[name=csrf-token]')?.getAttribute('content');
    return token || '';
  }
}

// Funções globais
function loadLogs() {
  window.logsViewer.loadLogs(true);
}

function loadMoreLogs() {
  window.logsViewer.loadLogs(false);
}

function clearFilters() {
  document.getElementById('filterTipo').value = '';
  document.getElementById('filterStatus').value = '';
  document.getElementById('filterUser').value = '';
  loadLogs();
}

// Inicializar quando DOM estiver pronto
document.addEventListener('DOMContentLoaded', () => {
  window.logsViewer = new CommunicationLogsViewer();
});
</script>
{% endblock %}