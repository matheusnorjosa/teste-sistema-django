{% load static %}
<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>{% block title %}Sistema Aprender{% endblock %}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="{% block description %}Sistema Aprender - Gestão Educacional{% endblock %}" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --content-bg: #f8f9fa;
      --sidebar-bg: #2c3e50;
      --sidebar-hover: #34495e; 
      --card: #ffffff; 
      --text: #2c3e50; 
      --muted: #6c757d; 
      --line: #e9ecef; 
      --accent: #3498db;
      --accent-hover: #2980b9;
      --success: #27ae60; 
      --warning: #f39c12; 
      --danger: #e74c3c;
      --ok: #198754; 
      --warn: #fd7e14; 
      --sidebar-width: 280px;
      --header-height: 80px;
      --shadow: 0 4px 15px rgba(0,0,0,0.08);
      --shadow-hover: 0 8px 25px rgba(0,0,0,0.15);
      --content-gutter: 1.25rem;
    }
    
    *{box-sizing:border-box; margin:0; padding:0;}
    
    body{
      background: var(--bg);
      color: var(--text); 
      font-family: 'Inter', system-ui, -apple-system, sans-serif; 
      overflow-x: hidden;
      line-height: 1.6;
    }
    
    /* Layout principal */
    .layout{display:flex; min-height:100vh}
    .sidebar{
      width:var(--sidebar-width); 
      background:var(--sidebar-bg); 
      color:#fff; 
      position:fixed; 
      height:100vh; 
      overflow-y:auto; 
      z-index:1000; 
      transition:all 0.3s ease;
      box-shadow: var(--shadow);
    }
    .main-content{
      flex:1; 
      margin-left:var(--sidebar-width); 
      transition:margin-left 0.3s ease;
      background: var(--content-bg);
      min-height: 100vh;
    }
    
    /* Sidebar styles */
    .sidebar-header{
      padding:2rem 1.5rem; 
      border-bottom:1px solid rgba(255,255,255,0.15);
      background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
    }
    .sidebar-header h4{
      margin:0; 
      font-size:1.3rem; 
      font-weight:700;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .sidebar-header .sub{
      font-size:0.85rem; 
      color:rgba(255,255,255,0.8); 
      margin-top:0.5rem;
      font-weight: 300;
    }
    
    .sidebar-nav{padding:1.5rem 0}
    .nav-section{margin-bottom:2rem}
    .nav-section-title{
      padding:0.75rem 1.5rem; 
      font-size:0.75rem; 
      color:rgba(255,255,255,0.6); 
      text-transform:uppercase; 
      letter-spacing:0.15em; 
      font-weight:600; 
      margin-bottom:0.75rem;
    }
    
    .nav-item{
      display:flex; 
      align-items: center;
      padding:1rem 1.5rem; 
      color:rgba(255,255,255,0.85); 
      text-decoration:none; 
      transition:all 0.3s ease; 
      border-left:4px solid transparent;
      font-weight: 500;
    }
    .nav-item:hover{
      background:var(--sidebar-hover); 
      color:#fff; 
      border-left-color:var(--accent);
      transform: translateX(4px);
    }
    .nav-item.active{
      background:var(--accent); 
      color:#fff; 
      border-left-color:#fff;
      box-shadow: inset -4px 0 8px rgba(0,0,0,0.2);
    }
    .nav-item i{
      width:1.5rem; 
      margin-right:1rem; 
      font-size:1.1rem;
      text-align: center;
    }
    .nav-item .badge{
      margin-left: auto;
      background: var(--accent);
      color: white;
      padding: 0.25rem 0.5rem;
      border-radius: 1rem;
      font-size: 0.75rem;
      font-weight: 600;
    }
    
    /* Responsive sidebar */
    @media (max-width: 768px) {
      .sidebar{transform:translateX(-100%)}
      .sidebar.show{transform:translateX(0)}
      .main-content{margin-left:0}
      .mobile-toggle{display:block}
    }
    .mobile-toggle{display:none; position:fixed; top:1rem; left:1rem; z-index:1001; background:var(--sidebar-bg); color:#fff; border:none; padding:0.5rem; border-radius:0.375rem}
    
    /* Main content */
    .content-wrap{
      padding: var(--content-gutter);
    }
    .page-header{
      background: linear-gradient(135deg, var(--card) 0%, #f8f9fa 100%);
      border-bottom:1px solid var(--line);
      padding: 1.5rem var(--content-gutter);
      margin: calc(var(--content-gutter) * -1)
              calc(var(--content-gutter) * -1)
              1rem
              calc(var(--content-gutter) * -1);
      box-shadow: var(--shadow);
      border-radius: 0 0 1rem 1rem;
      position: relative;
      overflow: hidden;
    }

    .page-header::before{
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--accent), #2563eb, var(--success));
      animation: headerShimmer 3s ease-in-out infinite;
    }

    @keyframes headerShimmer {
      0%, 100% { opacity: 0.8; }
      50% { opacity: 1; }
    }
    
    /* Em telas grandes, aumente o gutter para dar mais respiro do menu */
    @media (min-width: 1200px){
      :root{ --content-gutter: 2rem; }
    }

    /* Responsividade do header */
    @media (max-width: 768px) {
      .page-header-content {
        flex-direction: column;
        gap: 1rem;
        align-items: flex-start;
      }
      
      .page-header h1 {
        font-size: 1.5rem;
      }
      
      .page-header h1 i {
        font-size: 1.25rem;
      }
      
      .page-header .breadcrumb {
        font-size: 0.8rem;
      }
      
      .page-header .actions {
        width: 100%;
        justify-content: flex-end;
        flex-wrap: wrap;
      }
    }

    @media (max-width: 480px) {
      .page-header {
        padding: 1rem var(--content-gutter);
      }
      
      .page-header h1 {
        font-size: 1.25rem;
      }
      
      .page-header .breadcrumb::before {
        width: 16px;
      }
    }
    .page-header-content {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .page-header-main {
      flex: 1;
      min-width: 0;
    }

    .page-header h1{
      margin:0 0 0.5rem 0; 
      font-size:1.75rem; 
      font-weight:700; 
      color:var(--text);
      display: flex;
      align-items: center;
      gap: 0.75rem;
      line-height: 1.2;
    }

    .page-header h1 i {
      font-size: 1.5rem;
      background: linear-gradient(135deg, var(--accent), #2563eb);
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      opacity: 0.9;
    }

    .page-header .breadcrumb{
      margin:0; 
      font-size:0.875rem; 
      color:var(--muted);
      font-weight: 400;
      line-height: 1.4;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .page-header .breadcrumb::before {
      content: '';
      width: 24px;
      height: 1px;
      background: linear-gradient(90deg, var(--accent), transparent);
    }
    
    .page-header .actions{
      margin-top:0;
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    
    /* Forms */
    .form-group{margin-bottom:1.5rem}
    .form-label{display:block; margin-bottom:0.5rem; font-weight:500; color:var(--text)}
    .form-control{width:100%; padding:0.75rem; border:1px solid var(--line); border-radius:0.5rem; font-size:0.875rem; transition:all 0.2s ease}
    .form-control:focus{outline:none; border-color:var(--accent); box-shadow:0 0 0 3px rgba(13, 110, 253, 0.1)}
    .form-select{appearance:none; background-image:url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e"); background-position:right 0.75rem center; background-repeat:no-repeat; background-size:1.25rem; padding-right:2.5rem}
    .form-text{font-size:0.8rem; color:var(--muted); margin-top:0.25rem}
    
    /* Cards */
    .card{background:var(--card); border:1px solid var(--line); border-radius:0.75rem; padding:1.5rem; box-shadow:0 2px 4px rgba(0,0,0,0.05); margin-bottom:1.5rem}
    .card-header{background:#f8f9fa; border-bottom:1px solid var(--line); padding:1rem 1.5rem; margin:-1.5rem -1.5rem 1.5rem -1.5rem; border-radius:0.75rem 0.75rem 0 0}
    .card-title{margin:0; font-size:1.125rem; font-weight:600; color:var(--accent)}
    
    /* Tables */
    .table-container{overflow-x:auto; border-radius:0.75rem; border:1px solid var(--line)}
    .table{width:100%; margin:0; border-collapse:collapse}
    .table th{background:#f8f9fa; padding:1rem; border-bottom:1px solid var(--line); font-weight:600; color:var(--text); text-align:left}
    .table td{padding:1rem; border-bottom:1px solid var(--line)}
    .table tbody tr:hover{background:#f8f9fa}
    .table tbody tr:last-child td{border-bottom:none}
    
    /* Buttons */
    .btn{display:inline-flex; align-items:center; padding:0.75rem 1.5rem; border:1px solid var(--line); border-radius:0.5rem; background:#fff; text-decoration:none; color:var(--text); font-size:0.875rem; font-weight:500; transition:all 0.2s ease; cursor:pointer}
    .btn:hover{background:#f8f9fa; text-decoration:none; color:var(--text); transform:translateY(-1px)}
    .btn-primary{border-color:var(--accent); background:var(--accent); color:#fff}
    .btn-primary:hover{background:#0b5ed7; border-color:#0a58ca; color:#fff}
    .btn-success{border-color:var(--ok); background:var(--ok); color:#fff}
    .btn-success:hover{background:#157347; border-color:#146c43; color:#fff}
    .btn-warning{border-color:var(--warn); background:var(--warn); color:#fff}
    .btn-warning:hover{background:#e08e0b; border-color:#c77c0b; color:#fff}
    .btn-danger{border-color:var(--danger); background:var(--danger); color:#fff}
    .btn-danger:hover{background:#bb2d3b; border-color:#b02a37; color:#fff}
    .btn-sm{padding:0.5rem 1rem; font-size:0.8rem}
    .btn-lg{padding:1rem 2rem; font-size:1rem}
    .btn i{margin-right:0.5rem}
    .btn-group{display:flex; gap:0.5rem}
    
    /* Alerts */
    .alert{padding:1rem; border-radius:0.5rem; margin-bottom:1rem; border:1px solid}
    .alert-success{background:#d1e7dd; border-color:#badbcc; color:#0f5132}
    .alert-warning{background:#fff3cd; border-color:#ffecb5; color:#664d03}
    .alert-danger{background:#f8d7da; border-color:#f5c2c7; color:#842029}
    .alert-info{background:#d1ecf1; border-color:#b6effb; color:#055160}
    
    /* Badges */
    .badge{display:inline-block; padding:0.375rem 0.75rem; font-size:0.75rem; font-weight:600; border-radius:0.375rem; color:#fff}
    .badge-primary{background:var(--accent)}
    .badge-success{background:var(--ok)}
    .badge-warning{background:var(--warn)}
    .badge-danger{background:var(--danger)}
    .badge-secondary{background:var(--muted)}
    
    /* Utility classes */
    .text-primary{color:var(--accent)!important}
    .text-success{color:var(--ok)!important}
    .text-warning{color:var(--warn)!important}
    .text-danger{color:var(--danger)!important}
    .text-muted{color:var(--muted)!important}
    .mb-0{margin-bottom:0!important}
    .mb-1{margin-bottom:0.5rem!important}
    .mb-2{margin-bottom:1rem!important}
    .mb-3{margin-bottom:1.5rem!important}
    .mt-0{margin-top:0!important}
    .mt-1{margin-top:0.5rem!important}
    .mt-2{margin-top:1rem!important}
    .mt-3{margin-top:1.5rem!important}
    .text-center{text-align:center!important}
    .d-flex{display:flex!important}
    .justify-content-between{justify-content:space-between!important}
    .align-items-center{align-items:center!important}
    .gap-2{gap:1rem!important}
    
    footer{margin-top:3rem; padding:1.5rem 0; border-top:1px solid var(--line); color:var(--muted); font-size:0.8rem; text-center}
    
    /* CSS para link de acessibilidade - Pular para conteúdo */
    .visually-hidden-focusable {
      position: absolute !important;
      top: -40px;
      left: 10px;
      width: 1px;
      height: 1px;
      padding: 8px 16px;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
      background: var(--accent);
      color: white;
      text-decoration: none;
      border-radius: 4px;
      font-weight: 600;
      font-size: 0.9rem;
      z-index: 9999;
      transition: all 0.2s ease;
    }
    
    .visually-hidden-focusable:focus {
      position: absolute !important;
      top: 10px;
      left: 10px;
      width: auto;
      height: auto;
      padding: 8px 16px;
      margin: 0;
      overflow: visible;
      clip: auto;
      white-space: normal;
      box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
      transform: translateY(0);
    }
    
    {% block extra_css %}{% endblock %}
  </style>
</head>
<body>
  <!-- Skip link para acessibilidade -->
  <a href="#main-content" class="visually-hidden-focusable">Pular para o conteúdo principal</a>

  <!-- Mobile toggle -->
  <button class="mobile-toggle" onclick="toggleSidebar()" aria-label="Abrir menu de navegação" aria-expanded="false" aria-controls="sidebar">
    <i class="bi bi-list" aria-hidden="true"></i>
  </button>

  <div class="layout">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar" role="complementary" aria-label="Menu de navegação lateral">
      <header class="sidebar-header" role="banner">
        <h2><i class="bi bi-mortarboard-fill" aria-hidden="true"></i> Sistema Aprender</h2>
        <div class="sub">Gestão Interna</div>
      </header>
      
      <nav class="sidebar-nav" role="navigation" aria-label="Menu principal">
        <!-- Navegação Principal -->
        <div class="nav-section">
          <div class="nav-section-title">Principal</div>
          <a href="{% url 'core:home' %}" class="nav-item {% block nav_home %}{% endblock %}">
            <i class="bi bi-house"></i> Início
          </a>
          {% if user.is_superuser or user.setor.vinculado_superintendencia|default:False %}
          <a href="/disponibilidade/" class="nav-item {% block nav_mapa %}{% endblock %}">
            <i class="bi bi-calendar-check"></i> Mapa Mensal
          </a>
          {% endif %}
        </div>

        <!-- Operações por papel -->
        {% if perms.core.add_solicitacao or user.is_superuser %}
        <div class="nav-section">
          <div class="nav-section-title">Coordenação</div>
          <a href="/solicitar/" class="nav-item {% block nav_solicitar %}{% endblock %}">
            <i class="bi bi-plus-circle"></i> Solicitar Evento
          </a>
          <a href="{% url 'core:coordenador_meus_eventos' %}" class="nav-item {% block nav_coordenador_eventos %}{% endblock %}">
            <i class="bi bi-calendar-check"></i> Meus Eventos
          </a>
        </div>
        {% endif %}

        {% if perms.core.add_disponibilidadeformadores or user.is_superuser %}
        <div class="nav-section">
          <div class="nav-section-title">Formador</div>
          <a href="{% url 'core:formador_eventos' %}" class="nav-item {% block nav_formador %}{% endblock %}">
            <i class="bi bi-person-workspace"></i> Meus Eventos
          </a>
          <a href="/bloqueios/novo/" class="nav-item {% block nav_bloqueio %}{% endblock %}">
            <i class="bi bi-calendar-x"></i> Bloqueio de Agenda
          </a>
        </div>
        {% endif %}
        

        {% if user.is_superuser or user.setor.vinculado_superintendencia|default:False %}
        <div class="nav-section">
          <div class="nav-section-title">Superintendência</div>
          <a href="/aprovacoes/pendentes/" class="nav-item {% block nav_aprovacoes %}{% endblock %}">
            <i class="bi bi-clipboard-check"></i> Aprovações Pendentes
          </a>
          <a href="{% url 'core:deslocamentos_list' %}" class="nav-item {% block nav_deslocamentos %}{% endblock %}">
            <i class="bi bi-geo-alt"></i> Deslocamentos
          </a>
        </div>
        {% endif %}

        {% if user.is_superuser or user.setor.vinculado_superintendencia|default:False %}
        <div class="nav-section">
          <div class="nav-section-title">Controle</div>
          <a href="{% url 'core:controle_pre_agenda' %}" class="nav-item {% block nav_controle_pre_agenda %}{% endblock %}">
            <i class="bi bi-calendar-plus"></i> Pré-Agenda
          </a>
          <a href="{% url 'core:controle_google_calendar' %}" class="nav-item {% block nav_controle_calendar %}{% endblock %}">
            <i class="bi bi-cloud-check"></i> Monitor Google Calendar
          </a>
          <a href="{% url 'core:controle_auditoria' %}" class="nav-item {% block nav_controle_auditoria %}{% endblock %}">
            <i class="bi bi-shield-check"></i> Logs de Auditoria
          </a>
          <a href="{% url 'core:controle_api_status' %}" class="nav-item {% block nav_controle_api %}{% endblock %}">
            <i class="bi bi-speedometer2"></i> Status do Sistema
          </a>
        </div>
        {% endif %}

        {% if perms.core.view_relatorios or user.is_superuser %}
        <div class="nav-section">
          <div class="nav-section-title">Diretoria</div>
          <a href="{% url 'core:diretoria_dashboard' %}" class="nav-item {% block nav_diretoria_dashboard %}{% endblock %}">
            <i class="bi bi-graph-up"></i> Dashboard Executivo
          </a>
          <a href="{% url 'core:diretoria_dashboard_integrado' %}" class="nav-item {% block nav_diretoria_integrado %}{% endblock %}">
            <i class="bi bi-cpu"></i> Dashboard Integrado
          </a>
          <a href="{% url 'core:diretoria_relatorios' %}" class="nav-item {% block nav_diretoria_relatorios %}{% endblock %}">
            <i class="bi bi-file-earmark-bar-graph"></i> Relatórios Consolidados
          </a>
          {% if user.is_superuser or user.setor.vinculado_superintendencia|default:False %}
          <a href="/disponibilidade/" class="nav-item {% block nav_diretoria_calendar %}{% endblock %}">
            <i class="bi bi-calendar-month"></i> Visão Mensal
          </a>
          {% endif %}
          <a href="{% url 'core:diretoria_api_metrics' %}" class="nav-item {% block nav_diretoria_api %}{% endblock %}">
            <i class="bi bi-file-earmark-code"></i> Métricas API
          </a>
        </div>
        {% endif %}

        <!-- Gestão Administrativa - apenas para administradores -->
        {% if user.is_staff %}
        <div class="nav-section">
          <div class="nav-section-title">Gestão</div>
          <a href="{% url 'core:gestao_dashboard' %}" class="nav-item {% block nav_gestao_dashboard %}{% endblock %}">
            <i class="bi bi-gear-fill"></i> Dashboard Administrativo
          </a>
          <a href="{% url 'core:gestao_formadores' %}" class="nav-item {% block nav_gestao_formadores %}{% endblock %}">
            <i class="bi bi-people-fill"></i> Formadores
          </a>
          <a href="{% url 'core:gestao_municipios' %}" class="nav-item {% block nav_gestao_municipios %}{% endblock %}">
            <i class="bi bi-geo-alt-fill"></i> Municípios
          </a>
          <a href="{% url 'core:gestao_projetos' %}" class="nav-item {% block nav_gestao_projetos %}{% endblock %}">
            <i class="bi bi-briefcase-fill"></i> Projetos
          </a>
          <a href="{% url 'core:gestao_tipos_evento' %}" class="nav-item {% block nav_gestao_tipos_evento %}{% endblock %}">
            <i class="bi bi-calendar-event-fill"></i> Tipos de Evento
          </a>
        </div>
        {% endif %}

        <!-- Administração do Sistema - apenas para administradores -->
        {% if user.is_superuser %}
        <div class="nav-section">
          <div class="nav-section-title">Sistema</div>
          <a href="/admin/" class="nav-item {% block nav_admin %}{% endblock %}">
            <i class="bi bi-gear"></i> Administração
          </a>
        </div>
        {% endif %}
      </nav>
    </aside>

    <!-- Main content -->
    <main class="main-content" id="main-content" role="main" aria-labelledby="page-title">
      <header class="page-header" role="banner">
        <div class="page-header-content">
          <div class="page-header-main">
            <h1 id="page-title">{% block page_title %}{% endblock %}</h1>
            <nav class="breadcrumb" aria-label="Navegação estrutural (breadcrumb)">
              {% block breadcrumb %}{% endblock %}
            </nav>
          </div>
          <div class="actions">
            {% block page_actions %}{% endblock %}
            
            <!-- Widget de Notificações -->
            {% if user.is_authenticated %}
              {% include 'core/components/notifications_widget.html' %}
            {% endif %}
            
            <span style="font-weight: 500; color: var(--text); white-space: nowrap;">{{ user.get_full_name|default:user.username }}</span>
            <form method="post" action="{% url 'core:logout' %}" style="display: inline;">
              {% csrf_token %}
              <button type="submit" class="btn btn-sm" style="color: var(--danger); background: none; border: none;" title="Sair do sistema" aria-label="Sair do sistema">
                <i class="bi bi-box-arrow-right" aria-hidden="true"></i> Sair
              </button>
            </form>
          </div>
        </div>
      </header>
      
      <div class="content-wrap">
        <!-- Django messages -->
        {% if messages %}
          <div role="alert" aria-live="polite">
          {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">
              <i class="bi {% if message.tags == 'success' %}bi-check-circle{% elif message.tags == 'warning' %}bi-exclamation-triangle{% elif message.tags == 'error' %}bi-x-circle{% else %}bi-info-circle{% endif %}" aria-hidden="true"></i>
              {{ message }}
            </div>
          {% endfor %}
          </div>
        {% endif %}

        {% block content %}{% endblock %}

        <footer role="contentinfo">
          <i class="bi bi-gear" aria-hidden="true"></i> DAT • Desenvolvimento e Apoio Tecnológico — {{ user.username }}
        </footer>
      </div>
    </main>
  </div>

  <script>
    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('show');
    }
    
    // Close sidebar when clicking outside on mobile
    document.addEventListener('click', function(event) {
      const sidebar = document.getElementById('sidebar');
      const toggle = document.querySelector('.mobile-toggle');
      
      if (window.innerWidth <= 768 && 
          !sidebar.contains(event.target) && 
          !toggle.contains(event.target) && 
          sidebar.classList.contains('show')) {
        sidebar.classList.remove('show');
      }
    });
    
    {% block extra_js %}{% endblock %}
  </script>
</body>
</html>
